// Simplified Locate Control for Leaflet
L.Control.Locate = L.Control.extend({
    options: {
        position: 'topleft',
        drawCircle: true,
        follow: false,
        setView: true,
        keepCurrentZoomLevel: false,
        strings: {
            title: "Show me where I am"
        }
    },
    
    onAdd: function(map) {
        var container = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar leaflet-control');
        
        this._link = L.DomUtil.create('a', 'leaflet-control-locate-link', container);
        this._link.href = '#';
        this._link.title = this.options.strings.title;
        this._link.innerHTML = 'üìç';
        
        L.DomEvent.on(this._link, 'click', this._onClick, this);
        
        this._map = map;
        
        return container;
    },
    
    _onClick: function(e) {
        L.DomEvent.stopPropagation(e);
        L.DomEvent.preventDefault(e);
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                this._onLocationFound.bind(this),
                this._onLocationError.bind(this)
            );
        }
    },
    
    _onLocationFound: function(position) {
        var latlng = L.latLng(position.coords.latitude, position.coords.longitude);
        
        if (this.options.setView) {
            this._map.setView(latlng, this._map.getZoom());
        }
        
        if (this._marker) {
            this._map.removeLayer(this._marker);
        }
        
        this._marker = L.marker(latlng).addTo(this._map);
    },
    
    _onLocationError: function(error) {
        console.log('Location error: ' + error.message);
    }
});

L.control.locate = function(options) {
    return new L.Control.Locate(options);
};